<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªÙˆØ±Ù†Øª â€” Neon Tools</title>

  <!-- Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ CSS Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ (ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± ØµØ­ÙŠØ­) -->
  <link rel="stylesheet" href="../style.css">

  <style>
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù…ÙˆØ¶Ø¹ÙŠØ© Ù„ØµÙØ­Ø© Ø§Ù„ØªÙˆØ±Ù†Øª ÙÙ‚Ø· */
    .torrent-top {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .torrent-actions { display:flex; gap:10px; align-items:center; }
    .small-note { font-size:0.9rem; color: #9fbecb; margin-top:8px; }
    .spinner { border:4px solid rgba(255,255,255,0.06); border-top:4px solid rgba(255,255,255,0.12); border-radius:50%; width:26px; height:26px; animation: spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-left:8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .file-list ul { list-style: none; padding:0; margin:0; }
    .file-list li { padding:10px; border-bottom:1px dashed rgba(255,255,255,0.03); display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; }
    .file-meta { color:#bfeffb; font-size:0.95rem; }
    .tag { padding:6px 10px; border-radius:8px; background:rgba(0,255,163,0.06); color:#bdf; font-weight:600; font-size:0.85rem }
    .danger { background: linear-gradient(90deg,#ff6b6b,#ff3b3b); color:#100; padding:6px 10px; border-radius:8px; cursor:pointer; border:none; }
    .muted { color:#8ea; font-size:0.9rem }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body data-tool="torrent" class="tool-page">
  <div class="neon-gradient-bg"></div>

  <div class="tool-wrap">
    <div class="tool-header">
      <div>
        <h2 class="tool-title">ØªÙˆØ±Ù†Øª</h2>
        <p class="note">Ø§Ø±ÙØ¹ Ù…Ù„Ù <code>.torrent</code> Ø£Ùˆ Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· <code>magnet:</code> Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙˆØ±Ù†Øª â€” Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØªÙ… ÙÙƒ Ø§Ù„ØªÙˆØ±Ù†Øª ÙˆØ¥ØªØ§Ø­Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p>
      </div>
      <div>
        <button class="back-btn">â¬…ï¸ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>
    </div>

    <div class="panel">
      <div class="torrent-top">
        <div class="input-row">
          <label class="file-input" title="Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù .torrent">
            Ø§Ø®ØªØ± Ù…Ù„Ù .torrent
            <input id="torrentFile" type="file" accept=".torrent" style="display:none">
          </label>

          <div style="display:flex; gap:8px; align-items:center;">
            <button id="pasteMagnet" class="action-btn">Ù„ØµÙ‚ Magnet</button>
            <button id="refreshList" class="action-btn" title="ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ±Ù†Øª">ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>

        <div class="controls">
          <button id="clearBtn" class="back-btn">Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±Ø¶</button>
          <span id="statusTag" class="tag muted">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø´ÙŠØ¡</span>
        </div>
      </div>

      <div id="torrentOutput" class="file-list panel" style="min-height:120px">
        <p class="muted">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ ØªÙˆØ±Ù†Øª Ø¨Ø¹Ø¯...</p>
      </div>

      <p class="small-note">Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ø§Ù†: ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ù‚Ø¨Ù„ ØªÙ†Ø²ÙŠÙ„Ù‡. Ø§Ù„Ø³ÙŠØ±ÙØ± Ø³ÙŠØ­ÙØ¸ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù….</p>
    </div>
  </div>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØµÙØ­Ø© (ÙƒØ§Ù…Ù„) -->
  <script>
  (function(){
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const fileInput = document.getElementById('torrentFile');
    const pasteMagnetBtn = document.getElementById('pasteMagnet');
    const torrentOutput = document.getElementById('torrentOutput');
    const statusTag = document.getElementById('statusTag');
    const backBtn = document.querySelector('.back-btn');
    const refreshBtn = document.getElementById('refreshList');
    const clearBtn = document.getElementById('clearBtn');

    // ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
    if (backBtn) backBtn.addEventListener('click', () => window.location.href = '../index.html');

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    function formatBytes(bytes){
      if (!bytes && bytes !== 0) return '';
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes)/Math.log(k));
      return parseFloat((bytes/Math.pow(k,i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showStatus(text, busy=false){
      statusTag.textContent = text;
      if (busy){
        if (!statusTag.querySelector('.spinner')) {
          const s = document.createElement('span');
          s.className = 'spinner';
          statusTag.prepend(s);
        }
      } else {
        const s = statusTag.querySelector('.spinner');
        if (s) s.remove();
      }
    }

    function renderTorrent(data){
      // data: { infoHash, name, files: [{name,length}, ...] }
      const name = data.name || data.infoHash;
      const files = data.files || [];

      const html = [];
      html.push('<h3 style="margin-top:0;color:#bff">ğŸ“¦ ' + escapeHtml(name) + '</h3>');
      if (!files.length) {
        html.push('<p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø¸Ø§Ù‡Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙˆØ±Ù†Øª.</p>');
      } else {
        html.push('<ul>');
        files.forEach((f, i) => {
          const dl = `/download/${encodeURIComponent(data.infoHash)}/${i}`;
          html.push(`<li>
                       <div class="file-meta">${escapeHtml(f.name)}</div>
                       <div style="display:flex;gap:8px;align-items:center">
                         <div class="muted">${formatBytes(f.length)}</div>
                         <a class="result-link" href="${dl}">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</a>
                       </div>
                     </li>`);
        });
        html.push('</ul>');
      }
      html.push(`<p class="small-note">InfoHash: <span class="muted">${escapeHtml(data.infoHash)}</span></p>`);
      torrentOutput.innerHTML = html.join('');
    }

    function escapeHtml(s){
      if (!s) return '';
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    // Ø±ÙØ¹ Ù…Ù„Ù .torrent
    fileInput.addEventListener('change', async () => {
      const f = fileInput.files[0];
      if (!f) return;
      try {
        showStatus('Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªÙˆØ±Ù†Øª...', true);
        torrentOutput.innerHTML = `<p class="muted">â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±...</p>`;
        const fd = new FormData();
        fd.append('torrent', f);
        const res = await fetch('/upload-torrent', { method: 'POST', body: fd });
        if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: ' + res.statusText);
        const data = await res.json();
        showStatus('ØªÙˆØ±Ù†Øª Ù…ÙØ¶Ø§Ù: ' + (data.name || data.infoHash), false);
        renderTorrent(data);
      } catch (err) {
        showStatus('Ø®Ø·Ø£', false);
        torrentOutput.innerHTML = `<p class="muted">Ø®Ø·Ø£: ${escapeHtml(err.message)}</p>`;
        console.error(err);
      }
    });

    // Ù„ØµÙ‚ magnet
    pasteMagnetBtn.addEventListener('click', async () => {
      const magnet = prompt('Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· magnet Ù‡Ù†Ø§:');
      if (!magnet) return;
      try {
        showStatus('Ø¬Ø§Ø±Ù Ø¥Ø¶Ø§ÙØ© magnet...', true);
        torrentOutput.innerHTML = `<p class="muted">â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ magnet Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±...</p>`;
        const res = await fetch('/add-magnet', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ magnet })
        });
        if (!res.ok) throw new Error('ÙØ´Ù„: ' + res.statusText);
        const data = await res.json();
        showStatus('ØªÙˆØ±Ù†Øª Ù…ÙØ¶Ø§Ù: ' + (data.name || data.infoHash), false);
        renderTorrent(data);
      } catch (err) {
        showStatus('Ø®Ø·Ø£', false);
        torrentOutput.innerHTML = `<p class="muted">Ø®Ø·Ø£: ${escapeHtml(err.message)}</p>`;
        console.error(err);
      }
    });

    // Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«: ÙŠØ¹ÙŠØ¯ Ø¹Ø±Ø¶ Ø¢Ø®Ø± ØªÙˆØ±Ù†Øª Ø¥Ù† ÙˆÙØ¬Ø¯ (Ù…Ø­Ø¯ÙˆØ¯ - ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ ÙƒÙ„ Ø¥Ø¶Ø§ÙØ©)
    refreshBtn.addEventListener('click', async () => {
      // Ù„Ø§ ÙŠÙˆØ¬Ø¯ endpoint Ù„Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ Ù„Ø°Ù„Ùƒ Ù†Ø­ØªÙØ¸ Ø¨Ø£Ø­Ø¯Ø« Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± Ù†ÙØ³Ù‡
      if (torrentOutput.innerHTML.trim() === '' || torrentOutput.innerHTML.includes('Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„')) {
        torrentOutput.innerHTML = `<p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§. Ø§Ø±ÙØ¹ ØªÙˆØ±Ù†Øª Ø£Ùˆ Ø£Ù„ØµÙ‚ magnet Ø£ÙˆÙ„Ø§Ù‹.</p>`;
      } else {
        // Ù†Ø®Ù„ÙŠ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨Ø³ÙŠØ·
        showStatus('Ù…Ø­Ø¯Ø«', false);
        // Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø§ ÙŠÙ…Ù„Ùƒ endpoint Ø¹Ø§Ù… Ù„Ù„Ø­Ø§Ù„Ø©.
      }
    });

    clearBtn.addEventListener('click', () => {
      torrentOutput.innerHTML = `<p class="muted">ØªÙ… Ø§Ù„Ù…Ø³Ø­ â€” Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ ØªÙˆØ±Ù†Øª Ø¨Ø¹Ø¯...</p>`;
      showStatus('ÙØ§Ø±Øº', false);
      fileInput.value = '';
    });

    // ØªØ­Ø³ÙŠÙ†: Ø¯Ø¹Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ø±ÙØ¹ .torrent
    ;(function enableDragDrop(){
      const panel = torrentOutput;
      panel.addEventListener('dragover', e => { e.preventDefault(); panel.style.outline = '2px dashed rgba(0,255,163,0.12)'; });
      panel.addEventListener('dragleave', e => { e.preventDefault(); panel.style.outline = 'none'; });
      panel.addEventListener('drop', async (e) => {
        e.preventDefault(); panel.style.outline = 'none';
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (!f) return;
        if (!f.name.endsWith('.torrent')) {
          torrentOutput.innerHTML = `<p class="muted">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ Ù„ÙŠØ³ Ø¨ØµÙŠØºØ© .torrent</p>`;
          return;
        }
        // Ø¶Ø¹ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± input Ø«Ù… Ù†ÙÙ‘Ø° Ù†ÙØ³ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹
        fileInput.files = e.dataTransfer.files;
        // Ù†ÙÙ‘Ø° Ø±ÙØ¹
        const event = new Event('change');
        fileInput.dispatchEvent(event);
      });
      // Ø¯Ù„ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const note = document.createElement('p');
      note.className = 'muted';
      note.style.marginTop = '8px';
      note.textContent = 'ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨ Ù…Ù„Ù .torrent ÙˆØ¥ÙÙ„Ø§ØªÙ‡ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹.';
      panel.parentNode.insertBefore(note, panel.nextSibling);
    })();

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©: Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    showStatus('Ø¬Ø§Ù‡Ø²', false);

  })();
  </script>
</body>
</html>
